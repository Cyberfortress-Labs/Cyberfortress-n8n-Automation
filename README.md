# Cyberfortress n8n Automation

This repository contains the automation infrastructure for **Cyberfortress**, utilizing **n8n** to orchestrate security workflows, generate reports, and integrate with platforms like **Wazuh**, **SmartXDR**, and **Telegram**.

The project is containerized using Docker and includes a custom n8n image pre-configured with Puppeteer, Pandoc, and document generation tools.

## Features

- **Automated Active Response**:
  - Integrates with Wazuh to automatically **Isolate** or **Release** endpoints based on alerts.
  - executes SSH commands directly on the Wazuh Manager.
  - Sends real-time notifications to Telegram with execution logs.

- **Threat Intelligence & Reporting**:
  - Fetches IOCs (Indicators of Compromise) and AI analysis from SmartXDR.
  - Automatically generates **DOCX reports** from Markdown templates.
  - Supports inserting dynamic **screenshots** (full page or specific elements) using Puppeteer.
  - Converts Markdown to formatted Word documents using `docxtemplater` and `pandoc`.

- **Secure Remote Access**:
  - Uses **Cloudflare Tunnel** (`cloudflared`) to securely expose the local n8n instance without opening firewall ports.
  - Configured with basic authentication and SSL/TLS via Traefik labels (if used) or Cloudflare.

## Project Structure

```
├── .env.example                # Example environment variables
├── docker-compose.yml          # Docker composition for n8n and Cloudflare Tunnel
├── Dockerfile                  # Custom n8n image with Chrome, Pandoc, and extra nodes
├── work_flow/                  # Exported n8n workflow JSON files
│   ├── Wazuh_AR.json           # Workflow for Wazuh Active Response (Isolate/Release)
│   ├── Call_SmartXDR_API.json  # Workflow to query SmartXDR API
│   └── Network_IOCs_Responder.json # Network threat response workflow
├── src/                        # Custom JavaScript scripts for n8n Code Nodes
│   ├── generate-ioc-report.js  # transform IOC data into Markdown report format
│   ├── screenshot-full-page.js # Puppeteer script for full-page screenshots
│   ├── insert-image-to-docx.js # Helper to process images for docxtemplater
│   └── ...
└── certs/                      # Directory for custom CA certificates
```

## Prerequisites

- **Docker** and **Docker Compose** installed.
- A **Cloudflare** account (if using the tunnel).
- **Wazuh** and **SmartXDR** credentials (for the workflows).

## Installation & Setup

1.  **Clone the repository:**
    ```bash
    git clone https://github.com/Cyberfortress-Labs/Cyberfortress-n8n-Automation.git
    cd Cyberfortress-n8n-Automation
    ```

2.  **Configure Environment Variables:**
    Copy the example file and update it with your credentials:
    ```bash
    cp .env.example .env
    ```
    Key variables to configure in `.env`:
    - `DOMAIN_NAME` & `SUBDOMAIN`: For the n8n public URL.
    - `TUNNEL_TOKEN`: Your Cloudflare Tunnel token.
    - `N8N_BASIC_AUTH_USER` / `PASSWORD`: Login credentials for n8n.
    - `GENERIC_TIMEZONE`: e.g., `Asia/Ho_Chi_Minh`.

3.  **Build and Start:**
    Since this project uses a custom Dockerfile (to include Chrome/Pandoc), build the image first:
    ```bash
    docker-compose up -d --build
    ```

4.  **Access n8n:**
    - Open your browser and navigate to `https://<SUBDOMAIN>.<DOMAIN_NAME>` (or `http://localhost:5678` if running locally without tunnel).
    - Login with the credentials defined in your `.env`.

## Workflows Configuration

### 1. Wazuh Active Response (`Wazuh_AR.json`)
This workflow listens for Webhook events to trigger isolation or release actions on Wazuh agents.
- **Trigger**: Webhook (`POST /webhook/wazuh-action`)
- **Actions**:
  - Receives `agent_id` and `action` (isolate/release).
  - Connects to Wazuh Manager via **SSH** to run `isolation_manager.py`.
  - Notifies **Telegram** of the result (Success/Failure).
- **Setup**: You must configure the `SSH` and `Telegram` credentials in n8n after importing.

### 2. IOC Reporting (`Call_SmartXDR_API.json`)
Fetches threat data and compiles a report.
- **Logic**:
  - Queries SmartXDR for IOCs associated with a Case ID.
  - Uses `src/generate-ioc-report.js` to format the data into a Markdown table and detailed analysis section.
  - Converts Markdown to a DOCX file using a template.

## Customization

### Adding new Node.js Modules
The `Dockerfile` installs global packages required for document processing:
- `docxtemplater`
- `pizzip`
- `image-size`

To add more packages, update the `Dockerfile` in the `RUN npm install -g ...` section and rebuild.

### Modifying Reports
- **Logic**: Edit `src/generate-ioc-report.js` to change how data is mapped from JSON to Markdown.
- **Template**: Update the Word document template (usually uploaded to n8n or stored in `local-files`) ensuring tags match the keys generated by the script (e.g., `{{CASE_ID}}`, `{{IOC_TABLE_ROWS}}`).
